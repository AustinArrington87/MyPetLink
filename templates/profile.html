{% extends "base.html" %}

{% block title %}Pet Profile{% endblock %}

{% block content %}
<style>
    body {
        background: linear-gradient(135deg, #f0f7ff 0%, #fff5f5 100%);
        background-attachment: fixed;
    }

    .pet-card {
        background-color: white;
        background-image: 
            radial-gradient(circle at 100% 100%, rgba(66, 153, 225, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 0% 0%, rgba(66, 153, 225, 0.05) 0%, transparent 50%);
    }

    .health-card {
        background-color: white;
        background-image: 
            radial-gradient(circle at 100% 100%, rgba(72, 187, 120, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 0% 0%, rgba(72, 187, 120, 0.05) 0%, transparent 50%);
    }

    .location-card {
        background-color: white;
        background-image: 
            radial-gradient(circle at 100% 100%, rgba(159, 122, 234, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 0% 0%, rgba(159, 122, 234, 0.05) 0%, transparent 50%);
    }

    .save-button {
        background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        box-shadow: 0 4px 14px rgba(66, 153, 225, 0.4);
    }

    .save-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(66, 153, 225, 0.6);
    }

    .input-field {
        transition: all 0.3s ease;
    }

    .input-field:focus {
        transform: scale(1.02);
    }

    .avatar-container {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        position: relative;
        margin: 0 auto 1rem auto;
        background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
    }

    .avatar-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-container img.default-avatar {
        opacity: 0;
    }

    .avatar-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .avatar-container:hover .avatar-overlay {
        opacity: 1;
    }

    .pet-selector {
        display: flex;
        flex-wrap: nowrap;
        overflow-x: auto;
        gap: 1rem;
        padding: 1rem 0;
        margin-bottom: 2rem;
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    .pet-selector::-webkit-scrollbar {
        display: none;
    }

    .pet-option {
        flex: 0 0 auto;
        width: 80px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .pet-option.active {
        transform: scale(1.1);
    }

    .pet-option-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        overflow: hidden;
        margin: 0 auto 0.5rem auto;
        border: 3px solid transparent;
        transition: all 0.2s ease;
    }

    .pet-option.active .pet-option-avatar {
        border-color: #4299e1;
    }

    .pet-option-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .add-pet-option {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .add-pet-circle {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: #f3f4f6;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.5rem;
        border: 2px dashed #d1d5db;
        font-size: 1.5rem;
        color: #6b7280;
        transition: all 0.2s ease;
    }

    .add-pet-option:hover .add-pet-circle {
        background-color: #e5e7eb;
        border-color: #9ca3af;
    }

    .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
    }

    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        padding: 0 1.5rem;
    }

    .step-circle {
        width: 2rem;
        height: 2rem;
        border-radius: 50%;
        background-color: #e5e7eb;
        color: #6b7280;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin-bottom: 0.5rem;
        position: relative;
        z-index: 1;
    }

    .step.active .step-circle {
        background-color: #3b82f6;
        color: white;
    }

    .step.completed .step-circle {
        background-color: #10b981;
        color: white;
    }

    .step-text {
        font-size: 0.875rem;
        color: #6b7280;
        text-align: center;
    }

    .step.active .step-text {
        color: #3b82f6;
        font-weight: 500;
    }

    .step.completed .step-text {
        color: #10b981;
        font-weight: 500;
    }

    .step-line {
        position: absolute;
        top: 1rem;
        left: calc(50% + 1rem);
        right: calc(50% - 1rem);
        height: 2px;
        background-color: #e5e7eb;
        transform: translateY(-50%);
    }

    .step:last-child .step-line {
        display: none;
    }

    .step.completed .step-line {
        background-color: #10b981;
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
        }
    }

    .pulse {
        animation: pulse 2s infinite;
    }

    .human-card {
        background-color: white;
        background-image: 
            radial-gradient(circle at 100% 100%, rgba(255, 159, 64, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 0% 0%, rgba(255, 159, 64, 0.05) 0%, transparent 50%);
    }

    .tag {
        display: inline-block;
        background-color: #f3f4f6;
        color: #4b5563;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        margin: 0.25rem;
    }

    .tag:hover {
        background-color: #e5e7eb;
    }

    .default-avatar {
        background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
        object-fit: cover;
    }
</style>

<!-- Notification Container (always present) -->
<div id="notificationContainer" class="fixed top-4 right-4 z-50 w-96"></div>

<div class="fixed top-0 left-0 right-0 bg-white z-50 border-b border-gray-100">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
        <a href="{{ url_for('home') }}">
            <img src="{{ url_for('static', filename='img/pet_logo_text.png') }}" 
                 alt="MyPetLink Logo" 
                 class="h-8 drop-shadow-md hover:drop-shadow-lg transition-all duration-300">
        </a>
        <div class="flex items-center space-x-4">
            <a href="{{ url_for('profile') }}" 
               class="text-gray-600 hover:text-gray-900 transition-colors duration-200 flex items-center">
                <span class="mr-1">üêæ</span> Pet Profile
            </a>
            <a href="{{ url_for('logout') }}" 
               class="text-red-500 hover:text-red-700 transition-colors duration-200">
                Logout
            </a>
        </div>
    </div>
</div>

<div class="max-w-4xl mx-auto mt-20 px-4">
    <!-- Human Profile Section -->
    <div class="human-card rounded-2xl p-6 shadow-lg border-2 border-orange-100 transform transition-transform hover:scale-[1.01] mb-8">
        <div class="flex items-center mb-4">
            <span class="text-2xl mr-2">üë§</span>
            <h2 class="text-xl font-semibold text-orange-800">Your Profile</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Left Column: Avatar -->
            <div class="text-center">
                <div class="avatar-container mx-auto mb-4" style="width: 150px; height: 150px;">
                    <img id="userAvatar" 
                         src="{{ user_profile.avatar_url if user_profile.avatar_url else '/static/img/default_avatar.png' }}" 
                         alt="User Avatar" 
                         onerror="this.onerror=null; this.src='/static/img/default_avatar.png'; this.classList.add('default-avatar')"
                         class="{{ 'default-avatar' if not user_profile.avatar_url else '' }}">
                    <div class="avatar-overlay" onclick="openUserAvatarOptions()">
                        <button class="bg-white text-orange-800 px-3 py-1 rounded-full text-sm font-medium">
                            Change
                        </button>
                    </div>
                </div>
                <input type="file" id="userAvatarUpload" class="hidden" accept="image/*">
            </div>

            <!-- Middle Column: Basic Info -->
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-1">Name</label>
                    <input type="text" id="userName" value="{{ user_profile.name if user_profile.name else '' }}"
                           class="w-full px-4 py-2 rounded-xl border-2 border-orange-100 focus:border-orange-300 focus:ring focus:ring-orange-200 focus:ring-opacity-50 transition-colors"
                           placeholder="Your name">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-1">Email</label>
                    <input type="email" id="userEmail" value="{{ user_profile.email if user_profile.email else '' }}"
                           class="w-full px-4 py-2 rounded-xl border-2 border-orange-100 focus:border-orange-300 focus:ring focus:ring-orange-200 focus:ring-opacity-50 transition-colors"
                           placeholder="Your email">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-1">State</label>
                        <select id="userState" 
                                class="w-full px-4 py-2 rounded-xl border-2 border-orange-100 focus:border-orange-300 focus:ring focus:ring-orange-200 focus:ring-opacity-50 transition-colors"
                                onchange="updateCityOptions()">
                            <option value="">Select state</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-1">City</label>
                        <select id="userCity" 
                                class="w-full px-4 py-2 rounded-xl border-2 border-orange-100 focus:border-orange-300 focus:ring focus:ring-orange-200 focus:ring-opacity-50 transition-colors">
                            <option value="">Select city</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Right Column: Bio and Looking For -->
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-1">Bio</label>
                    <textarea id="userBio" rows="3"
                              class="w-full px-4 py-2 rounded-xl border-2 border-orange-100 focus:border-orange-300 focus:ring focus:ring-orange-200 focus:ring-opacity-50 transition-colors"
                              placeholder="Tell us about yourself">{{ user_profile.bio if user_profile.bio else '' }}</textarea>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-1">Looking For</label>
                    <div class="relative">
                        <button type="button" 
                                onclick="toggleLookingForDropdown()"
                                class="w-full px-4 py-2 rounded-xl border-2 border-orange-100 focus:border-orange-300 focus:ring focus:ring-orange-200 focus:ring-opacity-50 transition-colors text-left flex justify-between items-center">
                            <span id="lookingForDisplay">Select options</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="lookingForDropdown" class="hidden absolute z-10 w-full mt-1 bg-white rounded-xl border-2 border-orange-100 shadow-lg">
                            <div class="p-2 space-y-1">
                                <label class="flex items-center space-x-2 p-2 hover:bg-orange-50 rounded-lg cursor-pointer">
                                    <input type="checkbox" value="Pet Adoption" class="form-checkbox text-orange-500">
                                    <span>Pet Adoption</span>
                                </label>
                                <label class="flex items-center space-x-2 p-2 hover:bg-orange-50 rounded-lg cursor-pointer">
                                    <input type="checkbox" value="Play Dates" class="form-checkbox text-orange-500">
                                    <span>Play Dates</span>
                                </label>
                                <label class="flex items-center space-x-2 p-2 hover:bg-orange-50 rounded-lg cursor-pointer">
                                    <input type="checkbox" value="Pet Events" class="form-checkbox text-orange-500">
                                    <span>Pet Events</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Veterinary Clinic Information: Move to full width below the grid -->
        <div class="mt-8">
            <h3 class="text-lg font-medium mb-4 text-orange-700">Veterinary Clinic Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Clinic Name</label>
                    <input type="text" id="vetClinic" 
                           value="{{ user_profile.vet_name if user_profile and user_profile.vet_name }}"
                           class="w-full px-4 py-2 rounded-xl border-2 border-orange-100 focus:border-orange-300 focus:ring focus:ring-orange-200 focus:ring-opacity-50 transition-colors"
                           placeholder="Your pet's veterinary clinic">
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Clinic Phone</label>
                    <input type="tel" id="vetPhone" 
                           value="{{ user_profile.vet_phone if user_profile and user_profile.vet_phone }}"
                           class="w-full px-4 py-2 rounded-xl border-2 border-orange-100 focus:border-orange-300 focus:ring focus:ring-orange-200 focus:ring-opacity-50 transition-colors"
                           placeholder="(123) 456-7890"
                           pattern="^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$"
                           oninput="formatPhoneNumber(this)"
                           onblur="validatePhoneNumber(this)">
                    <p id="vetPhoneError" class="text-red-500 text-sm mt-1 hidden">Please enter a valid phone number</p>
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Clinic Address</label>
                    <input type="text" id="vetAddress" 
                           value="{{ user_profile.vet_address if user_profile and user_profile.vet_address }}"
                           class="w-full px-4 py-2 rounded-xl border-2 border-orange-100 focus:border-orange-300 focus:ring focus:ring-orange-200 focus:ring-opacity-50 transition-colors"
                           placeholder="Street address for the clinic">
                </div>
            </div>
        </div>

        <!-- Pet Overview -->
        <div class="mt-6 pt-6 border-t border-orange-100">
            <h3 class="text-lg font-medium text-orange-800 mb-4">Pet Overview</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for pet in pets %}
                <div class="bg-white rounded-xl p-4 shadow-sm border border-orange-100">
                    <div class="flex items-center space-x-3">
                        <img src="{{ pet.avatar if pet.avatar and pet.avatar.startswith('/') else pet.avatar if pet.avatar else '/static/img/pet_logo.png' }}" 
                             alt="{{ pet.name }}" 
                             class="w-12 h-12 rounded-full object-cover"
                             onerror="this.src='/static/img/pet_logo.png'">
                        <div>
                            <h4 class="font-medium text-gray-800">{{ pet.name }}</h4>
                            <p class="text-sm text-gray-500">{{ pet.species|title }} ‚Ä¢ {{ pet.breed }}</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="flex justify-end mt-6">
            <button onclick="saveUserProfile()" 
                    class="save-button text-white px-8 py-3 rounded-full text-lg font-medium transition-all duration-300 hover:bg-blue-600">
                Save Profile
            </button>
        </div>
    </div>

    <!-- Existing Pet Profile Section -->
    <div class="text-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">üêæ Pet Profile üêæ</h1>
        <p class="text-gray-600 mt-2">
            {% if is_first_pet %}
            Tell us about your furry (or scaly!) friend
            {% else %}
            Manage your pets' profiles and health information
            {% endif %}
        </p>
    </div>
    
    {% if not is_first_pet %}
    <!-- Pet Selector -->
    <div class="pet-selector">
        {% for pet in pets %}
        <div class="pet-option {% if pet.id == active_pet.id %}active{% endif %}" 
             onclick="selectPet('{{ pet.id }}')">
            <div class="pet-option-avatar">
                <img src="{{ pet.avatar if pet.avatar and pet.avatar.startswith('/') else pet.avatar if pet.avatar else '/static/img/pet_logo.png' }}" 
                     alt="{{ pet.name }}" onerror="this.src='/static/img/pet_logo.png'">
            </div>
            <div class="pet-option-name text-sm font-medium truncate">{{ pet.name }}</div>
        </div>
        {% endfor %}
        <div class="pet-option add-pet-option" onclick="addNewPet()">
            <div class="add-pet-circle">+</div>
            <div class="text-sm text-gray-500">Add Pet</div>
        </div>
    </div>
    {% endif %}
    
    <!-- Pet Form -->
    <div id="petForm">
        {% if is_first_pet %}
        <!-- Step Indicator (only for first pet) -->
        <div class="step-indicator">
            <div class="step active" id="step1">
                <div class="step-circle">1</div>
                <div class="step-text">Basic Info</div>
                <div class="step-line"></div>
            </div>
            <div class="step" id="step2">
                <div class="step-circle">2</div>
                <div class="step-text">Create Avatar</div>
                <div class="step-line"></div>
            </div>
            <div class="step" id="step3">
                <div class="step-circle">3</div>
                <div class="step-text">Health Details</div>
            </div>
        </div>
        {% endif %}

        <!-- Step 1: Basic Info -->
        <div id="basicInfoStep" class="{% if not is_first_pet %}mb-6{% endif %}">
            <div class="pet-card rounded-2xl p-6 shadow-lg border-2 border-blue-100 transform transition-transform hover:scale-[1.01]">
                <div class="flex items-center mb-4">
                    <span class="text-2xl mr-2">ü¶Æ</span>
                    <h2 class="text-xl font-semibold text-blue-800">Who's This Cutie?</h2>
                </div>
                
                <!-- Avatar Section -->
                <div class="text-center mb-6">
                    <div class="avatar-container" id="avatarContainer">
                        <img id="petAvatar" src="{{ active_pet.avatar if active_pet.avatar and active_pet.avatar.startswith('/') else active_pet.avatar if active_pet.avatar else '/static/img/pet_logo.png' }}" 
                             alt="Pet Avatar" onerror="this.src='/static/img/pet_logo.png'">
                        <div class="avatar-overlay" onclick="openAvatarOptions()">
                            <button class="bg-white text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                                Change
                            </button>
                        </div>
                    </div>
                </div>
                
                <input type="hidden" id="petId" value="{{ active_pet.id if active_pet }}">
                <input type="hidden" id="avatarUrl" value="{{ active_pet.avatar if active_pet.avatar }}">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="block text-gray-700 text-sm font-medium">Pet's Name</label>
                        <input type="text" id="petName" value="{{ active_pet.name if active_pet }}" 
                               class="w-full px-4 py-2 rounded-xl border-2 border-blue-100 focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 transition-colors"
                               placeholder="What's their name?">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-gray-700 text-sm font-medium">Species</label>
                        <select id="petType" 
                                class="w-full px-4 py-2 rounded-xl border-2 border-blue-100 focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 transition-colors"
                                onchange="loadBreeds()">
                            <option value="">What kind of pet are they?</option>
                            <option value="dog" {% if active_pet.species == 'dog' %}selected{% endif %}>üêï Dog</option>
                            <option value="cat" {% if active_pet.species == 'cat' %}selected{% endif %}>üê± Cat</option>
                            <option value="bird" {% if active_pet.species == 'bird' %}selected{% endif %}>ü¶ú Bird</option>
                            <option value="reptile" {% if active_pet.species == 'reptile' %}selected{% endif %}>ü¶é Reptile</option>
                            <option value="fish" {% if active_pet.species == 'fish' %}selected{% endif %}>üê† Fish</option>
                            <option value="rabbit" {% if active_pet.species == 'rabbit' %}selected{% endif %}>üê∞ Rabbit</option>
                            <option value="ferret" {% if active_pet.species == 'ferret' %}selected{% endif %}>ü¶¶ Ferret</option>
                            <option value="farm animal" {% if active_pet.species == 'farm animal' %}selected{% endif %}>üêÆ Farm Animal</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-gray-700 text-sm font-medium">Breed</label>
                        <select id="breedSelect" 
                                class="w-full px-4 py-2 rounded-xl border-2 border-blue-100 focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 transition-colors">
                            <option value="">Select species first</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-gray-700 text-sm font-medium">Age</label>
                        <div class="flex gap-4">
                            <div class="flex-1">
                                <input type="number" id="ageYears" placeholder="Years" min="0" max="30"
                                       value="{{ active_pet.age.years if active_pet.age }}"
                                       class="w-full px-4 py-2 rounded-xl border-2 border-blue-100 focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 transition-colors">
                                <span class="text-sm text-gray-500">Years</span>
                            </div>
                            <div class="flex-1">
                                <input type="number" id="ageMonths" placeholder="Months" min="0" max="11"
                                       value="{{ active_pet.age.months if active_pet.age }}"
                                       class="w-full px-4 py-2 rounded-xl border-2 border-blue-100 focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 transition-colors">
                                <span class="text-sm text-gray-500">Months</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% if is_first_pet %}
                <div class="flex justify-end mt-6">
                    <button onclick="nextStep(1)" 
                            class="save-button text-white px-8 py-3 rounded-full text-lg font-medium transition-all duration-300 hover:bg-blue-600 pulse">
                        Next: Create Avatar
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Step 2: Avatar Creation (Only visible in first-pet onboarding) -->
        <div id="avatarStep" class="{% if is_first_pet %}hidden{% endif %} mb-6">
            <div class="pet-card rounded-2xl p-6 shadow-lg border-2 border-blue-100 transform transition-transform hover:scale-[1.01]">
                <div class="flex items-center mb-4">
                    <span class="text-2xl mr-2">üñºÔ∏è</span>
                    <h2 class="text-xl font-semibold text-blue-800">Create a Pet Avatar</h2>
                </div>
                
                <div class="text-center mb-6">
                    <div class="avatar-container mx-auto mb-6" style="width: 200px; height: 200px;">
                        <img id="avatarPreview" src="{{ active_pet.avatar if active_pet.avatar and active_pet.avatar.startswith('/') else active_pet.avatar if active_pet.avatar else '/static/img/pet_logo.png' }}" 
                             alt="Pet Avatar" onerror="this.src='/static/img/pet_logo.png'">
                    </div>
                    
                    <div class="space-y-4">
                        <!--
                        <button onclick="generateAvatar()" 
                                class="bg-purple-600 text-white px-6 py-3 rounded-full hover:bg-purple-700 transform transition-all hover:scale-105 shadow-md mx-2">
                            ü™Ñ Generate with AI
                        </button>
                        -->
                        
                        <button onclick="uploadAvatar()" 
                                class="bg-blue-600 text-white px-6 py-3 rounded-full hover:bg-blue-700 transform transition-all hover:scale-105 shadow-md mx-2">
                            üì§ Upload Photo
                        </button>
                        
                        <input type="file" id="avatarUpload" class="hidden" accept="image/*">
                    </div>
                </div>
                
                {% if is_first_pet %}
                <div class="flex justify-between mt-6">
                    <button onclick="prevStep(2)" 
                            class="bg-gray-300 text-gray-800 px-6 py-2 rounded-full hover:bg-gray-400 transition-all">
                        Back
                    </button>
                    <button onclick="nextStep(2)" 
                            class="save-button text-white px-8 py-3 rounded-full text-lg font-medium transition-all duration-300 hover:bg-blue-600 pulse">
                        Next: Health Details
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Step 3: Health Details -->
        <div id="healthStep" class="{% if is_first_pet %}hidden{% endif %} mb-6">
            <div class="health-card rounded-2xl p-6 shadow-lg border-2 border-green-100 transform transition-transform hover:scale-[1.01]">
                <div class="flex items-center mb-4">
                    <span class="text-2xl mr-2">üíö</span>
                    <h2 class="text-xl font-semibold text-green-800">Health Details</h2>
                </div>
                <div class="space-y-6">
                    <div class="space-y-2">
                        <label class="block text-gray-700 text-sm font-medium">Weight (lbs)</label>
                        <input type="number" id="weight" step="0.1" min="0"
                               value="{{ active_pet.weight if active_pet }}"
                               class="w-full px-4 py-2 rounded-xl border-2 border-green-100 focus:border-green-300 focus:ring focus:ring-green-200 focus:ring-opacity-50 transition-colors"
                               placeholder="How much do they weigh?">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-gray-700 text-sm font-medium">Health Notes</label>
                        <textarea id="healthConditions" rows="3"
                                 class="w-full px-4 py-2 rounded-xl border-2 border-green-100 focus:border-green-300 focus:ring focus:ring-green-200 focus:ring-opacity-50 transition-colors"
                                 placeholder="Any ongoing health conditions or special care needs?">{{ active_pet.health_conditions if active_pet }}</textarea>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-gray-700 text-sm font-medium">Last Vet Visit</label>
                        <input type="date" id="lastCheckup"
                               value="{{ active_pet.last_checkup if active_pet }}"
                               class="w-full px-4 py-2 rounded-xl border-2 border-green-100 focus:border-green-300 focus:ring focus:ring-green-200 focus:ring-opacity-50 transition-colors">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-gray-700 text-sm font-medium">Last Vaccination Date</label>
                        <input type="date" id="lastVaccinationDate"
                               value="{{ active_pet.last_vaccination_date if active_pet }}"
                               class="w-full px-4 py-2 rounded-xl border-2 border-green-100 focus:border-green-300 focus:ring focus:ring-green-200 focus:ring-opacity-50 transition-colors">
                    </div>
                </div>
                
                {% if is_first_pet %}
                <div class="flex justify-between mt-6">
                    <button onclick="prevStep(3)" 
                            class="bg-gray-300 text-gray-800 px-6 py-2 rounded-full hover:bg-gray-400 transition-all">
                        Back
                    </button>
                    <button onclick="saveProfile()" 
                            class="save-button text-white px-8 py-3 rounded-full text-lg font-medium transition-all duration-300 hover:bg-blue-600 pulse">
                        Complete Profile
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Save Button (not shown in first-pet onboarding) -->
        {% if not is_first_pet %}
        <div class="text-center mb-8">
            <button onclick="saveProfile()" 
                    class="save-button text-white px-8 py-3 rounded-full text-lg font-medium transition-all duration-300 hover:bg-blue-600">
                üêæ Save Profile
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Avatar Options Modal -->
<div id="avatarModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 space-y-6">
        <h3 class="text-xl font-semibold text-center">Choose Avatar Option</h3>
        
        <div class="flex flex-col space-y-4">
            <!--
            <button onclick="generateAvatar()" 
                    class="bg-purple-600 text-white px-6 py-3 rounded-full hover:bg-purple-700 transform transition-all hover:scale-105">
                ü™Ñ Generate with AI
            </button>
            -->
            
            <button onclick="uploadAvatar()" 
                    class="bg-blue-600 text-white px-6 py-3 rounded-full hover:bg-blue-700 transform transition-all hover:scale-105 shadow-md mx-2">
                üì§ Upload Photo
            </button>
        </div>
        
        <button onclick="closeAvatarModal()" 
                class="w-full border border-gray-300 text-gray-600 px-6 py-3 rounded-xl hover:bg-gray-100">
            Cancel
        </button>
    </div>
</div>

<!-- Loading Indicator -->
<div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-xl shadow-lg text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
        <p class="text-lg font-medium text-gray-800" id="loadingText">Generating avatar...</p>
    </div>
</div>

<!-- User Avatar Modal -->
<div id="userAvatarModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 space-y-6">
        <h3 class="text-xl font-semibold text-center">Choose Avatar Option</h3>
        
        <div class="flex flex-col space-y-4">
            <button onclick="uploadUserAvatar()" 
                    class="bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 transform transition-all hover:scale-105">
                üì§ Upload Photo
            </button>
        </div>
        
        <button onclick="closeUserAvatarModal()" 
                class="w-full border border-gray-300 text-gray-600 px-6 py-3 rounded-xl hover:bg-gray-100">
            Cancel
        </button>
    </div>
</div>

<script>
let currentStep = 1;
let currentPetId = "{{ active_pet.id if active_pet else '' }}";
let isFirstPet = {% if is_first_pet %}true{% else %}false{% endif %};

// User Profile Functions
let lookingForTags = new Set({{ user_profile.looking_for|tojson if user_profile.looking_for else '[]' }});

// Add these new functions for state/city handling
let statesAndCities = {};

async function loadStatesAndCities() {
    try {
        const response = await fetch('/static/US_States_and_Cities.json');
        statesAndCities = await response.json();
        
        // Populate state dropdown
        const stateSelect = document.getElementById('userState');
        const states = Object.keys(statesAndCities).sort();
        
        states.forEach(state => {
            const option = document.createElement('option');
            option.value = state;
            option.textContent = state;
            stateSelect.appendChild(option);
        });

        // Set initial state if exists
        const currentState = "{{ user_profile.us_state if user_profile.us_state else '' }}";
        if (currentState) {
            stateSelect.value = currentState;
            updateCityOptions();
        }
    } catch (error) {
        console.error('Error loading states and cities:', error);
    }
}

function updateCityOptions() {
    const stateSelect = document.getElementById('userState');
    const citySelect = document.getElementById('userCity');
    const selectedState = stateSelect.value;
    
    // Clear existing options
    citySelect.innerHTML = '<option value="">Select city</option>';
    
    if (selectedState && statesAndCities[selectedState]) {
        const cities = statesAndCities[selectedState].sort();
        cities.forEach(city => {
            const option = document.createElement('option');
            option.value = city;
            option.textContent = city;
            citySelect.appendChild(option);
        });

        // Set initial city if exists
        const currentCity = "{{ user_profile.city if user_profile.city else '' }}";
        if (currentCity) {
            citySelect.value = currentCity;
        }
    }
}

// Looking For dropdown functions
function toggleLookingForDropdown() {
    const dropdown = document.getElementById('lookingForDropdown');
    dropdown.classList.toggle('hidden');
}

function updateLookingForDisplay() {
    const checkboxes = document.querySelectorAll('#lookingForDropdown input[type="checkbox"]:checked');
    const display = document.getElementById('lookingForDisplay');
    
    if (checkboxes.length === 0) {
        display.textContent = 'Select options';
    } else {
        display.textContent = `${checkboxes.length} selected`;
    }
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('lookingForDropdown');
    const button = document.querySelector('button[onclick="toggleLookingForDropdown()"]');
    
    if (!dropdown.contains(event.target) && !button.contains(event.target)) {
        dropdown.classList.add('hidden');
    }
});

// Initialize looking for checkboxes
document.addEventListener('DOMContentLoaded', function() {
    const lookingFor = {{ user_profile.looking_for|tojson if user_profile.looking_for else '[]' }};
    const checkboxes = document.querySelectorAll('#lookingForDropdown input[type="checkbox"]');
    
    checkboxes.forEach(checkbox => {
        if (lookingFor.includes(checkbox.value)) {
            checkbox.checked = true;
        }
        
        checkbox.addEventListener('change', updateLookingForDisplay);
    });
    
    updateLookingForDisplay();
    loadStatesAndCities();
});

// Phone number validation functions
function formatPhoneNumber(input) {
    // Remove all non-numeric characters
    let number = input.value.replace(/\D/g, '');
    
    // Format the number as (XXX) XXX-XXXX
    if (number.length > 0) {
        if (number.length <= 3) {
            number = '(' + number;
        } else if (number.length <= 6) {
            number = '(' + number.slice(0, 3) + ') ' + number.slice(3);
        } else {
            number = '(' + number.slice(0, 3) + ') ' + number.slice(3, 6) + '-' + number.slice(6, 10);
        }
    }
    
    input.value = number;
}

function validatePhoneNumber(input) {
    const phoneRegex = /^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/;
    const errorElement = document.getElementById('vetPhoneError');
    
    if (!input.value) {
        errorElement.classList.add('hidden');
        return true;
    }
    
    if (!phoneRegex.test(input.value)) {
        errorElement.classList.remove('hidden');
        input.classList.add('border-red-500');
        return false;
    }
    
    errorElement.classList.add('hidden');
    input.classList.remove('border-red-500');
    return true;
}

// Update saveUserProfile function to include phone validation
function saveUserProfile() {
    const name = document.getElementById('userName').value;
    const email = document.getElementById('userEmail').value;
    const bio = document.getElementById('userBio').value;
    const state = document.getElementById('userState').value;
    const city = document.getElementById('userCity').value;
    const vetPhone = document.getElementById('vetPhone');
    
    // Validate phone number before saving
    if (vetPhone.value && !validatePhoneNumber(vetPhone)) {
        showNotification('Please enter a valid phone number', 'error');
        return;
    }
    
    // Get selected looking for options
    const lookingFor = Array.from(document.querySelectorAll('#lookingForDropdown input[type="checkbox"]:checked'))
        .map(checkbox => checkbox.value);
    
    const avatar = document.getElementById('userAvatar').src;
    
    // Get vet information
    const vetName = document.getElementById('vetClinic').value;
    const vetAddress = document.getElementById('vetAddress').value;
    
    // Debug logging
    console.log('Sending profile data:', {
        name,
        email,
        bio,
        state,
        city,
        looking_for: lookingFor,
        vet_name: vetName,
        vet_phone: vetPhone.value,
        vet_address: vetAddress
    });
    
    fetch('/update_user_profile', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name,
            email,
            bio,
            state,
            city,
            looking_for: lookingFor,
            avatar: avatar,
            vet_name: vetName,
            vet_phone: vetPhone.value,
            vet_address: vetAddress
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Server response:', data);  // Debug logging
        if (data.success) {
            showNotification('Profile updated successfully!', 'success');
        } else {
            showNotification(data.error || 'Failed to update profile', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to update profile', 'error');
    });
}

function nextStep(step) {
    // Validate current step
    if (step === 1) {
        const petName = document.getElementById('petName').value;
        const species = document.getElementById('petType').value;
        
        if (!petName) {
            alert('Please enter your pet\'s name');
            return;
        }
        
        if (!species) {
            alert('Please select your pet\'s species');
            return;
        }
        
        // Generate avatar based on current info
        if (!document.getElementById('avatarUrl').value) {
            const generateBtn = document.getElementById('generateBtn');
            if (generateBtn) generateBtn.click();
        }
    }
    
    // Hide current step
    document.getElementById(`step${step}`).classList.remove('active');
    document.getElementById(`step${step + 1}`).classList.add('active');
}

function prevStep(step) {
    // Hide current step
    document.getElementById(`step${step}`).classList.remove('active');
    document.getElementById(`step${step - 1}`).classList.add('active');
}

function checkVaccinationDates() {
    const lastVaccinationDate = document.getElementById('lastVaccinationDate').value;
    const today = new Date().toISOString().split('T')[0];
    const vaccinationDate = new Date(lastVaccinationDate);
    const age = Math.floor((new Date() - vaccinationDate) / (1000 * 60 * 60 * 24 * 365));

    if (age < 0) {
        alert('Invalid vaccination date');
        document.getElementById('lastVaccinationDate').value = today;
    }
}

function loadBreeds(isInitialLoad = false) {
    const species = document.getElementById('petType').value;
    if (!species) return;

    const breedSelect = document.getElementById('breedSelect');
    breedSelect.innerHTML = '';

    fetch(`/breeds?species=${species}`)
        .then(response => response.json())
        .then(data => {
            if (data.length > 0) {
                breedSelect.innerHTML = '<option value="">Select breed</option>';
                data.forEach(breed => {
                    const option = document.createElement('option');
                    option.value = breed;
                    option.textContent = breed;
                    breedSelect.appendChild(option);
                });
            } else {
                breedSelect.innerHTML = '<option value="">No breeds found</option>';
            }
        })
        .catch(error => {
            console.error('Error loading breeds:', error);
            breedSelect.innerHTML = '<option value="">Error loading breeds</option>';
        });
}

function selectPet(petId) {
    // Update current pet ID
    currentPetId = petId;
    
    // Update active state in UI
    document.querySelectorAll('.pet-option').forEach(option => {
        option.classList.remove('active');
    });
    document.querySelector(`.pet-option[onclick="selectPet('${petId}')"]`).classList.add('active');
    
    // Reload the page with the selected pet
    window.location.href = `/profile?pet_id=${petId}`;
}

function addNewPet() {
    // Clear current pet ID to indicate new pet
    currentPetId = null;
    
    // Reset form fields
    document.getElementById('petName').value = '';
    document.getElementById('petType').value = '';
    document.getElementById('breedSelect').innerHTML = '<option value="">Select species first</option>';
    document.getElementById('ageYears').value = '';
    document.getElementById('ageMonths').value = '';
    document.getElementById('weight').value = '';
    document.getElementById('healthConditions').value = '';
    document.getElementById('lastCheckup').value = '';
    document.getElementById('lastVaccinationDate').value = '';
    document.getElementById('vetClinic').value = '';
    document.getElementById('vetPhone').value = '';
    document.getElementById('vetAddress').value = '';
    
    // Reset avatar
    document.getElementById('petAvatar').src = '/static/img/pet_logo.png';
    document.getElementById('avatarUrl').value = '';
    
    // Show first step
    document.querySelectorAll('.step').forEach(step => {
        step.classList.remove('active');
    });
    document.getElementById('step1').classList.add('active');
    
    // Update UI to show we're adding a new pet
    document.querySelector('.text-center h1').textContent = 'üêæ Add New Pet üêæ';
    document.querySelector('.text-center p').textContent = 'Tell us about your new furry (or scaly!) friend';
    
    // Show all steps
    document.getElementById('basicInfoStep').classList.remove('hidden');
    document.getElementById('avatarStep').classList.remove('hidden');
    document.getElementById('healthStep').classList.remove('hidden');
    
    // Update save button text
    const saveButton = document.querySelector('button[onclick="saveProfile()"]');
    if (saveButton) {
        saveButton.textContent = 'üêæ Save New Pet';
    }
}

function saveProfile() {
    // Implementation of saveProfile function
}

function openAvatarOptions() {
    // Implementation of openAvatarOptions function
}

function closeAvatarModal() {
    // Implementation of closeAvatarModal function
}

function uploadAvatar() {
    // Implementation of uploadAvatar function
}

function openUserAvatarOptions() {
    document.getElementById('userAvatarModal').classList.remove('hidden');
}

function closeUserAvatarModal() {
    document.getElementById('userAvatarModal').classList.add('hidden');
}

function uploadUserAvatar() {
    closeUserAvatarModal();
    document.getElementById('userAvatarUpload').click();
}

document.getElementById('userAvatarUpload').addEventListener('change', function(e) {
    if (e.target.files && e.target.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            document.getElementById('userAvatar').src = e.target.result;
            document.getElementById('userAvatar').classList.remove('default-avatar');
        }
        
        reader.readAsDataURL(e.target.files[0]);
    }
});
</script>
{% endblock %}